"""
Visualización del artefacto ECG antes / después de OBS
para UN canal ESG, usando ventana y escala controladas.
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import mne
from pathlib import Path

# ------------------- RUTAS -------------------

BASE = Path(r"C:\Users\navar\Desktop\ds004388-1.0.0")
EEG_ESG_1000 = BASE / "eeg_esg_1000Hz_noStimart"
ESG_CLEAN = BASE / "esg_1000Hz_ecgclean_obs"
RPEAKS_DIR = BASE / "rpeaks_christov_obs"
TASK_NAME = "median"


def load_rpeaks(subject, run):
    """Carga los tiempos de R-peaks (onset_sec) en segundos."""
    tsv = RPEAKS_DIR / f"sub-{subject:03d}_task-{TASK_NAME}_run-{run:02d}_rpeaks.tsv"
    df = pd.read_csv(tsv, sep="\t")
    return df["onset_sec"].to_numpy(dtype=float)


def plot_ecg_artifact_single(subject: int,
                             run: int,
                             channel: str,
                             tmin: float = -0.4,
                             tmax: float = 0.6,
                             max_beats: int = 150,
                             show_avg: bool = True):
    """
    Visualiza el artefacto ECG antes y después de OBS en un canal ESG.

    - Ventanas centradas en R-peak entre tmin y tmax (s).
    - Muestra latidos individuales y opcionalmente el promedio.
    - Eje Y en microvoltios, escala simétrica para before/after.
    """
    subj = f"sub-{subject:03d}"

    # --- Cargar before / after ---
    raw_before = mne.io.read_raw_fif(
        EEG_ESG_1000 / subj / f"noStimart_sr1000Hz_all_task-{TASK_NAME}_run-{run:02d}.fif",
        preload=True, verbose="error"
    )
    raw_after = mne.io.read_raw_fif(
        ESG_CLEAN / subj / f"noStimart_sr1000Hz_all_task-{TASK_NAME}_run-{run:02d}_ecgclean.fif",
        preload=True, verbose="error"
    )

    if channel not in raw_before.ch_names:
        raise RuntimeError(f"Canal {channel} no encontrado en raw_before.ch_names")

    # --- R-peaks ---
    qrs_times = load_rpeaks(subject, run)
    if qrs_times.size == 0:
        raise RuntimeError("No hay R-peaks para este sujeto/run.")

    sfreq = raw_before.info["sfreq"]
    ch_idx = raw_before.ch_names.index(channel)

    start_off = int(tmin * sfreq)
    end_off = int(tmax * sfreq)
    n_samples = raw_before.n_times

    epochs_before = []
    epochs_after = []

    # --- Extraer latidos ---
    for t in qrs_times[:max_beats]:
        center = int(t * sfreq)
        start = center + start_off
        end = center + end_off
        if start < 0 or end > n_samples:
            continue

        seg_before, _ = raw_before[ch_idx, start:end]
        seg_after, _ = raw_after[ch_idx, start:end]

        seg_before = seg_before[0]
        seg_after = seg_after[0]

        # restar la media de cada latido para ver mejor la forma
        seg_before = seg_before - seg_before.mean()
        seg_after = seg_after - seg_after.mean()

        epochs_before.append(seg_before)
        epochs_after.append(seg_after)

    if len(epochs_before) == 0:
        raise RuntimeError("No se pudo extraer ningún latido completo en esa ventana.")

    epochs_before = np.vstack(epochs_before)   # shape (n_beats, n_times)
    epochs_after = np.vstack(epochs_after)

    times = np.linspace(tmin, tmax, epochs_before.shape[1], endpoint=False)

    # --- Escala de amplitud en µV ---
    epochs_before_uV = epochs_before * 1e6
    epochs_after_uV = epochs_after * 1e6

    # límite simétrico para Y (misma escala before/after)
    y_max = max(np.max(np.abs(epochs_before_uV)),
                np.max(np.abs(epochs_after_uV)))
    y_lim = (-y_max, y_max)

    # --- Figura ---
    fig, ax = plt.subplots(figsize=(10, 4))

    # latidos individuales
    for ep in epochs_before_uV:
        ax.plot(times, ep, color="0.2", alpha=0.3, linewidth=0.7, label="before" if "before" not in ax.get_legend_handles_labels()[1] else None)

    for ep in epochs_after_uV:
        ax.plot(times, ep, color="tab:green", alpha=0.4, linewidth=0.7, label="after" if "after" not in ax.get_legend_handles_labels()[1] else None)

    # promedio
    if show_avg:
        mean_before = epochs_before_uV.mean(axis=0)
        mean_after = epochs_after_uV.mean(axis=0)
        ax.plot(times, mean_before, color="k", linewidth=2, label="before (mean)")
        ax.plot(times, mean_after, color="lime", linewidth=2, label="after (mean)")

    ax.axvline(0, color="red", linestyle="--", linewidth=1)
    ax.set_xlim(tmin, tmax)
    ax.set_ylim(-400, 1000)
    ax.set_xlabel("Time (s)")
    ax.set_ylabel("Amplitude (µV)")
    ax.set_title(f"ECG artefact removal using PCA-OBS\n{subj}, run-{run:02d}, channel {channel}")
    ax.grid(True, alpha=0.3)
    ax.legend(loc="upper right")
    fig.tight_layout()
    plt.show()


if __name__ == "__main__":
    # Cambia estos parámetros a lo que quieras ver
    plot_ecg_artifact_single(subject=1, run=3, channel="SC1")
